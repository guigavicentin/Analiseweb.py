import os
import subprocess
import re

def banner():
    print("""
@@@@@%+..........................................................................+%@@@@@@
@@@@#-...............................:-=+*##*+==:.................................-#@@@@@
@@%=................................+@@@@@@@@@@@@#..................................+%@@@
@#:................................-%@@@@@@@@@@@@@=..................................-#@@
*..................................%@@@@@@@@@@@@@@%....................................#@
..................................=%@@@@@@@@@@@@@@@+....................................#
..........................:-==+**+=---=+*#%%#*+=---=+**+==--.............................
...........................:=*#%@@@@@%%#*+=-+*#%@@@@@@@%*=-..............................
................................-+%@@@@@@@@@@@@@@@@%+-:..................................
..................................:%@@@@@@@@@@@@@@@-.....................................
...................................=@@@@@@@@@@@@@@*......................................
....................................*@@@@@@@@@@@@%.......................................
:-=++=-..............................+%@@@@@@@@%+:...............................-=++=-:.
@@@@@@@%*-.............................-+%@@%*-...............................-*%@@@@@@@#
.......=@@*...............................==................................:#@@@:....%@@
..@@@..=@@@+........................:-...-@@*...--:.........................*@@@@*+:..%@@
..@@@..=@@@#..................:-+*%@@@*...*%...+@@@%#+=-....................%@@@@@@-..%@@
..@@@..=@@@*..............=*#%@@@@@@@@@=..+%..:%@@@@@@@@@%#*=:..............*@@@@@@-..%@@
.......=@@#..............*@@@@@@@@@@@@@%:.#@-.%@@@@@@@@@@@@@@%:.............:%@@@@@-..%@@
%%%%%%%%#=..............*@@@@@@@@@@@@@@@#:%@+#@@@@@@@@@@@@@@@@%:..............=#@@@%%%@@%
-=+**+=:...............=@@@@@@@@@@@@@@@@@%@@@@@@@@@@@@@@@@@@@@@*................:=+**+=-.
....:-................:%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@+.................-......
.+-.:%+..............:%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@=..............=%+.:+:..
.#@%#%@%-............#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@-...........:#@@#%@@:..
.+%@@@@@@#+=-:......*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%.......-=+*%@@@@@%*...
...:=#%@@@@@@@@%#*+*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#+*##%@@@@@@@@%+-.....
.......=@@@@@@@@@@@@@@@@@@@##@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@@@@@@@@@@@@@@@@@@*:........
.......-@@@@@@@@@@@@@@@@@%+.-@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@.=%@@@@@@@@@@@@@@@@@+.........
........:-+*#%@@@@@@@@@@%-...%@@@@@@@@@@@@@@@@@@@@@@@@@@@@%..:*@@@@@@@@@@%%*+=-.........:
..............:-=+*#%%@+.....#@@@@@@@@@@@@@@@@@@@@@@@@@@@@*....=%@%#*+=-:..............:%
%-....................:......+%%%%%%%%%%%%%%%%%%%%%%%%%%%%=...........................-%@
@%+..................................................................................*%@@
""")

def run_command(command):
    print(f"Executando: {command}")
    result = subprocess.run(command, shell=True, capture_output=True, text=True)
    if result.returncode != 0:
        print(f"Erro: {result.stderr}")
    return result.stdout

def coletar_subdominios(alvo):
    run_command(f"shodanx subdomain -d {alvo} -o {alvo}_shodanx.txt")
    run_command(f"python3 subcat.py -d {alvo} -o {alvo}_subcat.txt")
    run_command(f"amass enum -active -norecursive -noalts -d {alvo} -o {alvo}_amass.txt")

    with open(f"{alvo}_unicos.txt", "w") as out_file:
        subdominios = set()
        for arquivo in [f"{alvo}_shodanx.txt", f"{alvo}_subcat.txt", f"{alvo}_amass.txt"]:
            if os.path.exists(arquivo):
                with open(arquivo, "r") as f:
                    subdominios.update(f.read().splitlines())
        out_file.write("\n".join(sorted(subdominios)))

def analisar_httpx(alvo):
    run_command(f"cat {alvo}_unicos.txt | httpx -td -title -sc -ip >> {alvo}_httpx.txt")
    ips = set()
    with open(f"{alvo}_httpx.txt", "r") as f:
        for line in f:
            matches = re.findall(r'\[(\d+\.\d+\.\d+\.\d+|[a-fA-F0-9:]+)\]', line)
            ips.update(matches)
    with open(f"{alvo}_ips.txt", "w") as f:
        f.write("\n".join(sorted(ips)))

def escanear_nmap(alvo):
    run_command(f"nmap -sS -p- -Pn -T4 --open -iL {alvo}_ips.txt -oN {alvo}_nmap.txt")
    portas = set()
    with open(f"{alvo}_nmap.txt", "r") as f:
        for line in f:
            if "/tcp" in line:
                portas.add(line.split("/")[0])
    if portas:
        resposta = input("Deseja identificar versões dos serviços? (s/n): ")
        if resposta.lower() == "s":
            run_command(f"nmap -p {','.join(portas)} -sV -Pn -T4 -iL {alvo}_ips.txt -oN {alvo}_nmap_detalhado.txt")

def main():
    banner()
    alvo = input("Digite o domínio alvo: ")
    coletar_subdominios(alvo)
    analisar_httpx(alvo)
    escanear_nmap(alvo)
    print("Análise concluída!")

if __name__ == "__main__":
    main()
